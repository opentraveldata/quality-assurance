language: python
python:
- 3.7-dev
addons:
  ssh_known_hosts:
  - "$TIPRX_SVR:$TIPRX_PRT"
  - "$TITSC_SVR"
  - "$TITSCNEW_SVR"
before_script:
- echo -e "Host tiproxy8\n\tHostName ${TIPRX_SVR}\n\tPort ${TIPRX_PRT}\n\tForwardAgent yes" >> ~/.ssh/config
- echo -e "Host titsc\n\tHostName ${TITSC_SVR}\n\tProxyCommand ssh -W %h:22 qa@tiproxy8" >> ~/.ssh/config
- echo -e "Host titscnew\n\tHostName ${TITSCNEW_SVR}\n\tProxyCommand ssh -W %h:22 qa@tiproxy8" >> ~/.ssh/config
install:
- pip install -r requirements.txt
script: make PY_EXEC=python checkers
before_deploy:
- openssl aes-256-cbc -K $encrypted_9cd66a2ab98f_key -iv $encrypted_9cd66a2ab98f_iv
  -in id_rsa.travis-ci-deploy.enc -out /tmp/id_rsa.travis-ci-deploy -d
- eval "$(ssh-agent -s)"
- chmod 600 /tmp/id_rsa.travis-ci-deploy
- ssh-add /tmp/id_rsa.travis-ci-deploy
deploy:
- provider: script
  skip_cleanup: true
  script: echo "DATA_DIR_BASE=${DATA_DIR_BASE}" \
    && export TODAY_DATE="$(date +%Y-%m-%d)" \
    && export DATA_DIR="${DATA_DIR_BASE}/${TODAY_DATE}" \
    && echo "TODAY_DATE=${TODAY_DATE} - DATA_DIR=${DATA_DIR}" \
    && ssh qa@titsc "mkdir -p ${DATA_DIR}" \
    && rsync -rav -e ssh results qa@titsc:${DATA_DIR}/ \
    && rsync -rav -e ssh to_be_checked qa@titsc:${DATA_DIR}/ \
    && ssh qa@titsc "bzip2 ${DATA_DIR}/to_be_checked/*.csv"
  on:
    branch: master

